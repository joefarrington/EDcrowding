# About this script
# ================

# Loads ED bed move data generated by get-ED-data-from-Star.R
# Creates an edge list, which contains one row per bed move per patient
# and has a timestamp. 
#
# Note that this does not do any grouping of nodes
# that is done in the script called 'Get-ED-data-from-Star.R'

# Load libraries
# ==============

library(dplyr)
library(tidyverse)
library(lubridate)


# Define functions
# ================

# define level of granularity for node
# if in ED use room, else node set to Admission for all wards
# note - this function should catch all rows where OTF is the last row
# as these have been set to Still in ED

get_node <- function(dept, room) {
  if (dept == "Still in ED") {
    node <- room
  }
  else {
    node <- dept
  }
}


# Load data
# =========

# ED bed move data generated by "get-ED-data-from-Star.R"
load("~/EDcrowding/flow-mapping/data-raw/ED_bed_moves_clean_MayJunJul_2020-08-06.rda")

# Summary for ED CSNs generated by "get-ED-data-from-Star.R"
load("~/EDcrowding/flow-mapping/data-raw/ED_csn_summ_MayJunJul_2020-08-06.rda")


# Create edge list
# ================

# create edge list which contains one row per bed move per patient with a time stamp
# note this is currently using room6 - see wiki for more on room information

edgedf <- tribble(
  ~mrn,
  ~csn,
  ~from,
  ~to,
  ~dttm)

current_csn = ED_bed_moves$csn[1]

for (i in (1:nrow(ED_bed_moves))) {
  
  if (i%%1000 == 0) {
    print(paste("Processed",i,"rows"))
  }
  
  from_node <- get_node(as.character(ED_bed_moves$dept3[i]), as.character(ED_bed_moves$room6[i]))
  
  if (ED_bed_moves$csn[i+1] == current_csn) {
    
    to_node <- get_node(as.character(ED_bed_moves$dept3[i+1]), as.character(ED_bed_moves$room6[i+1]))
    
    if (from_node != to_node) {
      edgedf <- edgedf %>% add_row(tibble_row(
        mrn = ED_bed_moves$mrn[i],
        csn = ED_bed_moves$csn[i],
        from = from_node,
        to = to_node,
        dttm = ED_bed_moves$discharge_new[i]
      ))
    }
  }
  else {# last row for current csn
    edgedf <- edgedf %>% add_row(tibble_row(
      mrn = ED_bed_moves$mrn[i],
      csn = ED_bed_moves$csn[i],
      from = to_node,
      to = "Discharged",
      dttm = ED_bed_moves$discharge_dttm[i]
    ))
    
    current_csn <- ED_bed_moves$csn[i+1]
  }
}


# save edge list for future use
outFile = paste0("EDcrowding/flow-mapping/data-raw/ED_edgelist_extra_August_",today(),".rda")
save(edgedf, file = outFile)
rm(outFile)

# OR load edge list if already saved



